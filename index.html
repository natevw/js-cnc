<!doctype html>
<html><head>
  <meta charset="utf-8">
  <title>CNC Controller</title>
  <style>
    .jog { display: inline-block; border: 1px solid black; padding: 10px; padding-right: 30px; }
    .jog .y { position: relative; left: 15px; }
    .jog .z { position: relative; left: 20px; }
    .jog button { width: 35px; }
  </style>
</head><body>

<div class="readout">
<h3>Machine</h3>
<label>X: <input class="x mach" readonly></input></label>
<label>Y: <input class="y mach" readonly></input></label>
<label>Z: <input class="z mach" readonly></input></label>
<h3>Work</h3>
<label>X: <input class="x work" readonly></input></label>
<label>Y: <input class="y work" readonly></input></label>
<label>Z: <input class="z work" readonly></input></label>
</div>

<div class="jog">
  <button class="y pos">Y+</button>
  <button class="z pos">Z+</button><br>
  <button class="x neg">X-</button>
  <button class="x pos">X+</button><br>
  <button class="y neg">Y-</button>
  <button class="z neg">Z-</button>
</div>

<script>
var ws = new WebSocket("ws://localhost:8000");
ws.onmessage = function (evt) {
  var d = JSON.parse(evt.data);
  if (d.status) updateStatus(d.status);
  else console.log(evt.data);
};
ws.onopen = function () {
  console.log("ready");
  sendJSON({str:"G91 G0"});
  setInterval(function () {
    sendJSON({req:'status'});
  }, 100);
};

function sendJSON(d) {
  ws.send(JSON.stringify(d));
}

function updateStatus(arr) {
  var mIdx = arr.indexOf('MPos');
  document.querySelector(".readout .x.mach").value = arr[mIdx+1];
  document.querySelector(".readout .y.mach").value = arr[mIdx+2];
  document.querySelector(".readout .z.mach").value = arr[mIdx+3];
  var wIdx = arr.indexOf('WPos');
  document.querySelector(".readout .x.work").value = arr[wIdx+1];
  document.querySelector(".readout .y.work").value = arr[wIdx+2];
  document.querySelector(".readout .z.work").value = arr[wIdx+3];
}

document.querySelector(".jog .x.neg").addEventListener('click', function () {
  sendJSON({str:"X-1"});
}, false);
document.querySelector(".jog .x.pos").addEventListener('click', function () {
  sendJSON({str:"X+1"});
}, false);
document.querySelector(".jog .y.neg").addEventListener('click', function () {
  sendJSON({str:"Y-1"});
}, false);
document.querySelector(".jog .y.pos").addEventListener('click', function () {
  sendJSON({str:"Y+1"});
}, false);
document.querySelector(".jog .z.neg").addEventListener('click', function () {
  sendJSON({str:"Z-1"});
}, false);
document.querySelector(".jog .z.pos").addEventListener('click', function () {
  sendJSON({str:"Z+1"});
}, false);

</script>

</body></html>