<!doctype html>
<html><head>
  <meta charset="utf-8">
  <title>CNC Controller</title>
  <style>
    .jog { display: inline-block; border: 1px solid black; padding: 10px; padding-right: 30px; }
    .jog .y { position: relative; left: 15px; }
    .jog .z { position: relative; left: 20px; }
    .jog button { width: 35px; }
    .proto {
      display: block; position: relative;
      width: 100px; height: 100px;
      background: grey;
      margin: 2em;
      cursor: crosshair;
    }
    .proto span {
      display: block; position: absolute;
      left: 0; right: 0; width: 5px;
      top: 0; bottom: 0; height: 5px;
      margin: auto;
      background: black;
      border-radius: 2.5px;
    }
  </style>
</head><body>

<div class="readout">
<h3>Machine</h3>
<label>X: <input class="x mach" readonly></input></label>
<label>Y: <input class="y mach" readonly></input></label>
<label>Z: <input class="z mach" readonly></input></label>
<h3>Work</h3>
<label>X: <input class="x work" readonly></input></label>
<label>Y: <input class="y work" readonly></input></label>
<label>Z: <input class="z work" readonly></input></label>
</div>

<div class="jog">
  <button class="y pos">Y+</button>
  <button class="z pos">Z+</button><br>
  <button class="x neg">X-</button>
  <button class="x pos">X+</button><br>
  <button class="y neg">Y-</button>
  <button class="z neg">Z-</button>
</div>

<div class="proto"><span></span></div>

<script>
var ws = new WebSocket("ws://localhost:8000");
ws.onmessage = function (evt) {
  var d = JSON.parse(evt.data);
  if (d.status) updateStatus(d.status);
  else if (!d.ok) console.log(evt.data);
};
ws.onopen = function () {
  console.log("ready");
  setInterval(function () {
    sendJSON({req:'status'});
  }, 100);
};

function sendJSON(d) {
  ws.send(JSON.stringify(d));
}

function moveRel(axes) {
  sendJSON({str:"G91 G0 "+axes});
}

function updateStatus(arr) {
  var mIdx = arr.indexOf('MPos');
  document.querySelector(".readout .x.mach").value = arr[mIdx+1];
  document.querySelector(".readout .y.mach").value = arr[mIdx+2];
  document.querySelector(".readout .z.mach").value = arr[mIdx+3];
  var wIdx = arr.indexOf('WPos');
  document.querySelector(".readout .x.work").value = arr[wIdx+1];
  document.querySelector(".readout .y.work").value = arr[wIdx+2];
  document.querySelector(".readout .z.work").value = arr[wIdx+3];
}

document.querySelector(".jog .x.neg").addEventListener('click', function () {
  moveRel("X-1");
}, false);
document.querySelector(".jog .x.pos").addEventListener('click', function () {
  moveRel("X+1");
}, false);
document.querySelector(".jog .y.neg").addEventListener('click', function () {
  moveRel("Y-1");
}, false);
document.querySelector(".jog .y.pos").addEventListener('click', function () {
  moveRel("Y+1");
}, false);
document.querySelector(".jog .z.neg").addEventListener('click', function () {
  moveRel("Z-1");
}, false);
document.querySelector(".jog .z.pos").addEventListener('click', function () {
  moveRel("Z+1");
}, false);


var pad = document.querySelector(".proto");
pad.addEventListener('mousedown', function () {
    var box = pad.getBoundingClientRect();
    console.log("DOWN");
    window.addEventListener('mousemove', move, false);
    window.addEventListener('mouseup', done, false);
    function move(evt) {
      var _x = (evt.clientX - box.left) / box.width,
          x = Math.max(-1, Math.min((_x - 0.5) * 2, 1)),
          _y = (evt.clientY - box.top) / box.height,
          y = Math.max(-1, Math.min((0.5 - _y) * 2, 1));
      console.log("move", x, y);
      if (Math.abs(x) < 0.05) x = 0;
      if (Math.abs(y) < 0.05) y = 0;
      setJog(x,y,0);
    }
    function done(evt) {
      console.log("DONE")
      setJog(0,0,0);
      window.removeEventListener('mousemove', move, false);
      window.removeEventListener('mouseup', done, false);
    }
}, false);

var jogger,
    jx = 0, jy = 0, jz = 0,
    F = 500 / 60e3, T = 10;
function setJog(x,y,z) {
  if (typeof x == 'number') jx = x;
  if (typeof y == 'number') jy = y;
  if (typeof z == 'number') jz = z;
  if (!x && !y && !z) { clearInterval(jogger); jogger = null; }
  else if (!jogger) jogger = setInterval(function () {
    var scale = F * T;
    moveRel([
      "X" + (jx*scale).toFixed(4),
      "Y" + (jy*scale).toFixed(4),
      "Z" + (jz*scale).toFixed(4),
    ].join(' '));
  }, T);
}    



</script>

</body></html>